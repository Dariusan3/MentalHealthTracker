@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MentalHealthTracker.Models
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<AuthorizeView>
    <Authorized>
        <MudAlert Severity="Severity.Success" Class="mb-2">Signed in as: @context.User.Identity?.Name</MudAlert>
        <MudNavMenu>
            <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
            <MudNavLink Href="jurnal" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Book">Journal</MudNavLink>
            <MudNavLink Href="statistici" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.BarChart">Statistics</MudNavLink>
            <MudNavLink Href="resurse" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LibraryBooks">Resources</MudNavLink>
            <MudNavLink Href="profil" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Person">Profile</MudNavLink>
            <MudNavLink Href="aichat" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.SmartToy">AI Chat</MudNavLink>
            <MudNavLink Href="subscription" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Star">Upgrade to Premium</MudNavLink>
            
            <MudDivider />
            <MudNavLink OnClick="ForceLogout" Icon="@Icons.Material.Filled.ExitToApp" Class="mud-error-text">Logout</MudNavLink>
        </MudNavMenu>
    </Authorized>
    <NotAuthorized>
        <MudAlert Severity="Severity.Success" Class="mb-2">Not signed in</MudAlert>
        <MudNavMenu>
            <MudNavLink Href="/home" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
            <MudNavLink Href="account/login" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Login">Login</MudNavLink>
            <MudNavLink Href="account/register" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.PersonAdd">Register</MudNavLink>
        </MudNavMenu>
    </NotAuthorized>
</AuthorizeView>

<MudDivider Class="my-2" />
@code {
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            // Force component reload when URL changes
            NavigationManager.LocationChanged += (sender, e) => StateHasChanged();
        }
    }
    
    private async Task ForceLogout()
    {
        // Show confirmation message
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to log out?");
        if (!confirmed) return;
        
        // Force logout using JavaScript
        await JSRuntime.InvokeVoidAsync("forceLogout");
    }
    
    private class AuthStatus
    {
        public bool IsAuthenticated { get; set; }
        public string UserName { get; set; } = "";
        public string UserId { get; set; } = "";
    }
}
