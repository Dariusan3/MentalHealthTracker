@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MentalHealthTracker.Models
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<AuthorizeView>
    <Authorized>
        <MudMenu Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight">
            <MudMenuItem>
                <div class="d-flex flex-column">
                    <MudText Typo="Typo.subtitle1">@context.User.Identity?.Name</MudText>
                    <MudText Typo="Typo.caption">Authenticated user</MudText>
                </div>
            </MudMenuItem>
            <MudDivider />
            <MudMenuItem Href="profil" Icon="@Icons.Material.Filled.Person">Profile</MudMenuItem>
            <MudMenuItem Href="jurnal" Icon="@Icons.Material.Filled.Book">Journal</MudMenuItem>
            <MudMenuItem Href="statistici" Icon="@Icons.Material.Filled.BarChart">Statistics</MudMenuItem>
            <MudMenuItem Href="resurse" Icon="@Icons.Material.Filled.LibraryBooks">Resources</MudMenuItem>
            <MudDivider />
            <MudMenuItem OnClick="CheckAuthStatus" Icon="@Icons.Material.Filled.Security">Check Authentication</MudMenuItem>
            <MudMenuItem OnClick="BeginSignOut" Icon="@Icons.Material.Filled.Logout">Logout</MudMenuItem>
        </MudMenu>
    </Authorized>
    <NotAuthorized>
        <MudStack Row="true">
            <MudButton Variant="Variant.Text" Color="Color.Inherit" Href="account/register">Register</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="account/login">Login</MudButton>
        </MudStack>
    </NotAuthorized>
</AuthorizeView>

@code {
    private async Task CheckAuthStatus()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;
        var userName = authState.User.Identity?.Name ?? "unknown";
        
        await JSRuntime.InvokeVoidAsync("alert", isAuthenticated 
            ? $"Authenticated as: {userName}" 
            : "You are not authenticated");
    }
    
    private async Task BeginSignOut()
    {
        try
        {
            // Forcing data clearance from localStorage and sessionStorage
            await JSRuntime.InvokeVoidAsync("localStorage.clear");
            await JSRuntime.InvokeVoidAsync("sessionStorage.clear");
            
            // Forcing cookie clearance via JavaScript
            await JSRuntime.InvokeVoidAsync("eval", @"
                document.cookie.split(';').forEach(function(c) {
                    document.cookie = c.trim().split('=')[0] + '=;' + 'expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;';
                });
            ");
            
            // Showing a confirmation message
            await JSRuntime.InvokeVoidAsync("alert", "You have been logged out successfully!");
            
            // Redirecting to direct logout endpoint
            NavigationManager.NavigateTo("/api/account/logout-direct", true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error logging out: {ex.Message}");
            
            // In case of error, redirecting to logout endpoint anyway
            NavigationManager.NavigateTo("/api/account/logout-direct", true);
        }
    }
}