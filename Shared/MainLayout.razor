@inherits LayoutComponentBase
@using MudBlazor
@using MentalHealthTracker.Shared
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ThemeService ThemeService
@inject UserProfileService UserProfileService

<MudThemeProvider Theme="AppTheme" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h6" Class="ml-3">Mental Health Tracker</MudText>
        <MudSpacer />
        <MudIconButton Icon="@(ThemeService.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" Color="Color.Inherit" OnClick="ToggleTheme" Title="Toggle theme" />
        <LoginDisplay />
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavMenu />
    </MudDrawer>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="my-4 pt-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _isAuthenticated = false;
    private string _userName = "";

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task ToggleTheme()
    {
        await ThemeService.ToggleTheme();
        SetThemeFromService();
        StateHasChanged();

        // Update user profile as well
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (userId != null)
            {
                var userProfile = await UserProfileService.GetUserProfileAsync(userId);
                if (userProfile != null)
                {
                    userProfile.Tema = ThemeService.IsDarkMode ? "dark" : "light";
                    await UserProfileService.CreateOrUpdateProfileAsync(userProfile);
                }
            }
        }
    }

    private MudTheme AppTheme = new MudTheme()
    {
        Palette = new PaletteLight()
        {
            Primary = "#3B82F6",
            Secondary = "#60A5FA",
            Tertiary = "#F97316",
            AppbarBackground = "#3B82F6",
            Background = "#F8FAFC",
            TextPrimary = "#1E293B",
            TextSecondary = "#475569",
            DrawerBackground = "#FFFFFF",
            Surface = "#FFFFFF"
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#60A5FA",
            Secondary = "#3B82F6",
            Tertiary = "#FB923C",
            AppbarBackground = "#1E293B",
            Background = "#0F172A",
            TextPrimary = "#F1F5F9",
            TextSecondary = "#CBD5E1",
            DrawerBackground = "#1E293B",
            Surface = "#1E293B"
        },
        Typography = new Typography()
        {
            Default = new Default() { FontFamily = new[] { "Raleway", "Helvetica", "Arial", "sans-serif" } },
            H1 = new H1() { FontFamily = new[] { "Lora", "serif" }, FontWeight = 700 },
            H2 = new H2() { FontFamily = new[] { "Lora", "serif" }, FontWeight = 600 },
            H3 = new H3() { FontFamily = new[] { "Lora", "serif" }, FontWeight = 600 },
            H4 = new H4() { FontFamily = new[] { "Lora", "serif" }, FontWeight = 600 },
            H5 = new H5() { FontFamily = new[] { "Lora", "serif" }, FontWeight = 500 },
            H6 = new H6() { FontFamily = new[] { "Lora", "serif" }, FontWeight = 500 },
            Body1 = new Body1() { FontFamily = new[] { "Raleway", "sans-serif" }, FontSize = "1rem", LineHeight = 1.5 },
            Body2 = new Body2() { FontFamily = new[] { "Raleway", "sans-serif" }, FontSize = ".875rem", LineHeight = 1.43 },
            Button = new Button() { FontFamily = new[] { "Raleway", "sans-serif" }, FontWeight = 600, TextTransform = "none" },
            Caption = new Caption() { FontFamily = new[] { "Raleway", "sans-serif" } },
            Subtitle1 = new Subtitle1() { FontFamily = new[] { "Raleway", "sans-serif" }, FontWeight = 600 },
            Subtitle2 = new Subtitle2() { FontFamily = new[] { "Raleway", "sans-serif" }, FontWeight = 500 }
        }
    };

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        ThemeService.OnThemeChanged += OnThemeChanged;
        
        // Check and apply saved theme
        var currentAuthState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (currentAuthState.User.Identity?.IsAuthenticated == true)
        {
            var userId = currentAuthState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (userId != null)
            {
                var userProfile = await UserProfileService.GetUserProfileAsync(userId);
                if (userProfile != null)
                {
                    if (userProfile.Tema == "dark")
                        await ThemeService.SetTheme(true);
                    else if (userProfile.Tema == "light")
                        await ThemeService.SetTheme(false);
                }
            }
        }
        
        SetThemeFromService();
        
        // Check authentication status
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;
        _userName = authState.User.Identity?.Name ?? "";
        
        Console.WriteLine($"OnInitializedAsync: Authenticated: {_isAuthenticated}, User: {_userName}");
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Check auth status from JavaScript
                await JSRuntime.InvokeVoidAsync("checkAuthStatus");
                
                // Check auth status from .NET
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                _isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;
                _userName = authState.User.Identity?.Name ?? "";
                
                Console.WriteLine($"OnAfterRenderAsync: Authenticated: {_isAuthenticated}, User: {_userName}");
                
                // Check if we have auth info in localStorage
                var localAuthState = await JSRuntime.InvokeAsync<AuthState>("authHelpers.getLocalAuthState");
                var triedRefresh = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "tried_refresh") == "true";
                
                if (localAuthState.IsAuthenticated && !triedRefresh && !_isAuthenticated)
                {
                    Console.WriteLine($"Auth state found in localStorage but not in session: {localAuthState.UserName}");
                    
                    // Set flag to avoid infinite loop
                    await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "tried_refresh", "true");
                    
                    // Force session refresh
                    await JSRuntime.InvokeVoidAsync("forceAuthRefresh");
                    
                    // Remove flag after 5 seconds
                    await Task.Delay(5000);
                    await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", "tried_refresh");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error in OnAfterRenderAsync: {ex.Message}");
            }
        }
    }

    private void OnThemeChanged()
    {
        SetThemeFromService();
        StateHasChanged();
    }

    private void SetThemeFromService()
    {
        if (ThemeService.IsDarkMode)
        {
            AppTheme.Palette = AppTheme.PaletteDark;
        }
        else
        {
            AppTheme.Palette = new PaletteLight()
            {
                Primary = "#3B82F6",
                Secondary = "#60A5FA",
                Tertiary = "#F97316",
                AppbarBackground = "#3B82F6",
                Background = "#F8FAFC",
                TextPrimary = "#1E293B",
                TextSecondary = "#475569",
                DrawerBackground = "#FFFFFF",
                Surface = "#FFFFFF"
            };
        }
    }

    private class AuthState
    {
        public bool IsAuthenticated { get; set; }
        public string UserId { get; set; } = "";
        public string UserName { get; set; } = "";
    }
}
