@page "/payment/success"
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@using Microsoft.AspNetCore.WebUtilities
@using MudBlazor
@using MentalHealthTracker.Services
@inject StripeService StripeService

<PageTitle>Payment Successful</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="d-flex justify-center align-center" Style="min-height: 80vh;">
    <MudCard Elevation="8" Class="p-6 rounded-xl text-center animate__animated animate__fadeInUp" Style="max-width: 500px; width: 100%;">
        <MudCardContent>
            @if (isLoading)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                <MudText Typo="Typo.h6" Class="mt-4">Processing payment...</MudText>
            }
            else if (isError)
            {
                <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" Class="mb-2" />
                <MudText Typo="Typo.h6" Color="Color.Error" Class="mb-4">@errorMessage</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GoToSubscription" Class="mt-4">
                    Try again
                </MudButton>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Warning" Size="Size.Large" Class="mb-2 animate__animated animate__tada" />
                <MudChip Color="Color.Warning" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Star" Class="mb-3" Style="font-size:1.2rem;">Premium activated!</MudChip>
                <MudText Typo="Typo.h4" Color="Color.Success" Class="mb-2">Payment processed successfully!</MudText>
                <MudText Typo="Typo.h6" Class="mb-2">Thank you for subscribing to the <b>Premium</b> plan!</MudText>
                <MudText Typo="Typo.body1" Class="mb-2">You can now enjoy <b>unlimited conversations</b> with our chatbot.</MudText>
                <MudDivider Class="my-3" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" OnClick="GoToChat" Class="me-2" StartIcon="@Icons.Material.Filled.Chat">Start chatting</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Large" OnClick="GoToHome" StartIcon="@Icons.Material.Filled.Home">Back to home</MudButton>
                <MudText Typo="Typo.caption" Class="mt-4 d-block" Color="Color.Info">
                    <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" Size="Size.Medium" Class="me-1" />Transaction ID: <b>@sessionId</b>
                </MudText>
            }
        </MudCardContent>
    </MudCard>
</MudContainer>

<MudSnackbarProvider />

@code {
    private string sessionId = string.Empty;
    private bool isLoading = true;
    private bool isError = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("session_id", out var sessionIdValue))
        {
            sessionId = sessionIdValue!;
            await VerifyPayment();
        }
        else
        {
            isError = true;
            errorMessage = "Could not find payment session ID.";
            isLoading = false;
        }
    }

    private async Task VerifyPayment()
    {
        try
        {
            var result = await StripeService.VerifyAndActivateSubscription(sessionId);
            if (result)
            {
                await JSRuntime.InvokeVoidAsync("eval", "if(window.confetti){window.confetti()};");
            }
            else
            {
                isError = true;
                errorMessage = "Could not verify payment. Please contact support.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error VerifyPayment: {ex.Message}");
            isError = true;
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoToChat()
    {
        NavigationManager.NavigateTo("/aichat");
    }

    private void GoToHome()
    {
        NavigationManager.NavigateTo("/");
    }

    private void GoToSubscription()
    {
        NavigationManager.NavigateTo("/subscription");
    }

    private class VerifyResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
    }
}