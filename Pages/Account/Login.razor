@page "/account/login"
@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MentalHealthTracker.Models
@using MudBlazor
@using System.Net.Http.Json
@inject NavigationManager NavigationManager
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Mental Health Tracker - Sign In</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex justify-center align-center" Style="height: 80vh;">
    <MudCard Elevation="3" Class="rounded-lg pa-4" Style="width: 100%;">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">Sign In</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4" Variant="Variant.Filled">@errorMessage</MudAlert>
            }
             @if (!string.IsNullOrEmpty(successMessage))
            {
                <MudAlert Severity="Severity.Success" Class="mb-4" Variant="Variant.Filled">@successMessage</MudAlert>
            }
            
            <EditForm Model="@loginRequest" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="loginRequest.Email" 
                                     Label="Email" 
                                     Variant="Variant.Outlined" 
                                     InputType="InputType.Email"
                                     Required="true" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="loginRequest.Password" 
                                     Label="Password" 
                                     Variant="Variant.Outlined" 
                                     InputType="@passwordInputType"
                                     Adornment="Adornment.End" 
                                     AdornmentIcon="@passwordIcon" 
                                     OnAdornmentClick="TogglePasswordVisibility"
                                     Required="true" />
                    </MudItem>
                    <MudItem xs="12">
                        <div class="d-flex justify-space-between align-center">
                            <MudCheckBox @bind-Value="loginRequest.RememberMe" Label="Remember me" Color="Color.Primary" />
                        </div>
                    </MudItem>
                    <MudItem xs="12">
                        <MudButton ButtonType="ButtonType.Submit" 
                                  Variant="Variant.Filled" 
                                  Color="Color.Primary" 
                                  Size="Size.Large"
                                  FullWidth="true"
                                  Disabled="@isProcessing">
                            @if (isProcessing)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Processing...</MudText>
                            }
                            else
                            {
                                <MudText>Sign In</MudText>
                            }
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </EditForm>
        </MudCardContent>
        <MudCardActions Class="d-flex justify-center pb-4 flex-column">
            <MudText Align="Align.Center" Class="mb-2">Don't have an account?</MudText>
            <a href="/account/register" class="mud-button-root mud-button mud-button-outlined mud-button-outlined-secondary mud-button-filled-size-medium mud-ripple mud-width-full">
                <span class="mud-button-label">Sign Up</span>
            </a>
        </MudCardActions>
    </MudCard>
</MudContainer>

@code {
    private LoginRequest loginRequest = new LoginRequest();
    private bool isProcessing = false;
    private string? errorMessage;
    private string? successMessage;
    
    private bool isPasswordVisible = false;
    private InputType passwordInputType => isPasswordVisible ? InputType.Text : InputType.Password;
    private string passwordIcon => isPasswordVisible ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    
    protected override async Task OnInitializedAsync()
    {
        // Check if user is already authenticated
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            Console.WriteLine("Login.razor: User already authenticated. Redirecting to /home.");
            NavigationManager.NavigateTo("/home", forceLoad: true);
            return;
        }

        // Get returnUrl parameter from query string if exists
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("returnUrl", out var returnUrlValues))
        {
            // Keep returnUrl for redirect after successful authentication
        }
    }
    
    private void TogglePasswordVisibility()
    {
        isPasswordVisible = !isPasswordVisible;
    }
    
    private async Task HandleSubmit()
    {
        if (isProcessing)
            return;
            
        isProcessing = true;
        errorMessage = null;
        
        try
        {
            Console.WriteLine($"Attempting authentication for {loginRequest.Email}");
            var response = await Http.PostAsJsonAsync("api/account/login", loginRequest);
            Console.WriteLine($"Authentication response: {response.StatusCode}");
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                if (result != null && result.Success)
                {
                    successMessage = "Authentication successful! Redirecting...";
                    Console.WriteLine($"Authentication successful for {loginRequest.Email}");
                    Console.WriteLine($"UserId: {result.UserId}, UserName: {result.UserName}");
                    StateHasChanged();
                    
                    try
                    {
                        await JSRuntime.InvokeVoidAsync("eval", $@"
                            console.log('Saving authentication state...');
                            if (window.authHelpers && window.authHelpers.saveAuthState) {{
                                window.authHelpers.saveAuthState(true, '{result.UserId}', '{result.UserName}');
                                console.log('State saved successfully!');
                            }} else {{
                                console.error('authHelpers.saveAuthState not available!');
                                localStorage.setItem('isAuthenticated', 'true');
                                localStorage.setItem('userId', '{result.UserId}');
                                localStorage.setItem('userName', '{result.UserName}');
                            }}
                            
                            sessionStorage.setItem('login_success', 'true');
                        ");
                        
                        await JSRuntime.InvokeVoidAsync("checkAuthStatus");
                        await Task.Delay(1000);
                        NavigationManager.NavigateTo("/", true);
                    }
                    catch (Exception ex)
                    {
                        errorMessage = $"JavaScript error: {ex.Message}. Redirecting...";
                        Console.WriteLine($"JavaScript error: {ex.Message}");
                        StateHasChanged();
                        await Task.Delay(1000);
                        NavigationManager.NavigateTo("/", true);
                    }
                    return;
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Authentication error: {errorContent}");
                
                try
                {
                    var errorResult = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                    errorMessage = errorResult?.Message ?? "Authentication error. Please try again.";
                }
                catch
                {
                    errorMessage = $"Authentication error: {response.StatusCode}";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Authentication error: {ex.Message}";
            Console.WriteLine($"Authentication exception: {ex.Message}");
        }
        
        isProcessing = false;
        StateHasChanged();
    }
    
    private class LoginRequest
    {
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
        public bool RememberMe { get; set; }
    }
    
    private class LoginResponse
    {
        public bool Success { get; set; }
        public string RedirectUrl { get; set; } = "/";
        public string UserId { get; set; } = "";
        public string UserName { get; set; } = "";
    }
    
    private class ErrorResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
    }
}