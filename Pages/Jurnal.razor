@page "/jurnal"
@using MentalHealthTracker.Models
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using System.Security.Claims
@using System.Text.Json
@using System.Text
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@attribute [Authorize]

<style>
    .mud-tabs {
        background: var(--mud-palette-surface);
        border-radius: 8px;
        overflow: hidden;
    }

    .mud-tab {
        color: var(--mud-palette-text-primary);
        transition: background-color 0.2s ease;
        background: var(--mud-palette-surface);
    }

    .mud-tab:hover {
        background: var(--mud-palette-background-grey);
    }

    .mud-tab.mud-selected {
        background: var(--mud-palette-primary);
        color: var(--mud-palette-primary-contrast);
    }

    .mud-tab-panel {
        background: var(--mud-palette-surface);
        border-radius: 0 0 8px 8px;
        padding: 1rem;
    }

    .mud-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 8px;
    }

    .mud-card-content {
        color: var(--mud-palette-text-primary);
    }

    .mud-text {
        color: var(--mud-palette-text-primary);
    }

    .mud-text-field {
        color: var(--mud-palette-text-primary);
    }

    .mud-text-field-label {
        color: var(--mud-palette-text-primary);
    }

    .mud-text-field-input {
        color: var(--mud-palette-text-primary);
    }

    .mud-text-field-helper-text {
        color: var(--mud-palette-text-secondary);
    }

    .mud-button {
        color: var(--mud-palette-text-primary);
    }

    .mud-button-filled {
        color: var(--mud-palette-primary-contrast);
    }

    .mud-expansion-panel {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .mud-expansion-panel-header {
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
    }

    .mud-expansion-panel-content {
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
    }

    .mud-table {
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
    }

    .mud-table-head {
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
    }

    .mud-table-row {
        color: var(--mud-palette-text-primary);
    }

    .mud-table-cell {
        color: var(--mud-palette-text-primary);
    }

    .mud-table-footer {
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
    }

    .mud-table-toolbar {
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
    }

    .mud-chip {
        color: var(--mud-palette-text-primary);
    }

    .mud-pagination {
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
    }

    .mud-pagination-item {
        color: var(--mud-palette-text-primary);
    }

    .mud-pagination-item-selected {
        background: var(--mud-palette-primary);
        color: var(--mud-palette-primary-contrast);
    }

    .mud-dialog {
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
    }

    .mud-dialog-title {
        color: var(--mud-palette-text-primary);
    }

    .mud-dialog-content {
        color: var(--mud-palette-text-primary);
    }

    .mud-dialog-actions {
        background: var(--mud-palette-surface);
    }
</style>

<PageTitle>Mental Health Tracker - Journal</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h3" Class="mb-4">My Journal</MudText>

    @if (isLoading)
    {
        <div class="d-flex flex-column align-center my-8">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Class="mt-4">Loading entries...</MudText>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudPaper Class="pa-4 my-4" Elevation="3">
            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-3">
                @errorMessage
            </MudAlert>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadEntries">
                Retry
            </MudButton>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="pa-4" Elevation="3">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h5">Add a new entry</MudText>
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          OnClick="@(() => showAddDialog = true)"
                          StartIcon="@Icons.Material.Filled.Add">
                    Add
                </MudButton>
            </div>

            <MudDivider Class="my-4" />

            @if (entries == null || !entries.Any())
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mb-3">
                    No journal entries yet. Add your first entry to start tracking your mood.
                </MudAlert>
            }
            else
            {
                <MudTable Items="@entries" 
                         Dense="true" 
                         Hover="true" 
                         Bordered="true" 
                         Striped="true"
                         Loading="@isLoading"
                         LoadingProgressColor="Color.Primary"
                         Filter="new Func<MoodEntry,bool>(FilterFunc)"
                         FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                         @bind-SelectedItem="selectedEntry"
                         MultiSelection="false"
                         FixedHeader="true"
                         Height="400px"
                         Breakpoint="Breakpoint.Sm"
                         RowClassFunc="@((entry, index) => GetRowClass(entry))">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Entries</MudText>
                        <MudSpacer />
                        <MudTextField @bind-Value="searchString" 
                                    Placeholder="Search..." 
                                    Adornment="Adornment.Start" 
                                    AdornmentIcon="@Icons.Material.Filled.Search" 
                                    IconSize="Size.Medium" 
                                    Class="mt-0" />
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>Date</MudTh>
                        <MudTh>Mood</MudTh>
                        <MudTh>Activities</MudTh>
                        <MudTh>Triggers</MudTh>
                        <MudTh>Sleep Hours</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Date">@context.Date.ToString("MM/dd/yyyy")</MudTd>
                        <MudTd DataLabel="Mood">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@GetMoodIcon(context.MoodLevel)" 
                                        Color="@GetMoodColor(context.MoodLevel)" 
                                        Class="mr-2" />
                                @context.MoodLevel / 10
                            </div>
                        </MudTd>
                        <MudTd DataLabel="Activities">@context.Activities</MudTd>
                        <MudTd DataLabel="Triggers">@context.Triggers</MudTd>
                        <MudTd DataLabel="Sleep Hours">@(context.SleepHours?.ToString() ?? "-")</MudTd>
                        <MudTd DataLabel="Actions">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                         Color="Color.Primary" 
                                         Size="Size.Small"
                                         OnClick="@(() => EditEntry(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                         Color="Color.Error" 
                                         Size="Size.Small"
                                         OnClick="@(() => DeleteEntry(context))" />
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            }
        </MudPaper>
    }
</MudContainer>

<MudDialog @bind-IsVisible="showAddDialog" 
           Options="dialogOptions"
           FullWidth="true"
           MaxWidth="MaxWidth.Medium">
    <TitleContent>
        <MudText Typo="Typo.h6">Add a new entry</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@success">
            <MudGrid>
                <MudItem xs="12">
                    <MudDatePicker Date="@newEntry.Date"
                                 DateChanged="@(date => newEntry.Date = date ?? DateTime.Now)"
                                 Label="Date" 
                                 Required="true"
                                 RequiredError="Date is required"
                                 Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudNumericField @bind-Value="newEntry.MoodLevel" 
                                   Label="Mood (1-10)" 
                                   Min="1" 
                                   Max="10" 
                                   Required="true"
                                   RequiredError="Mood is required"
                                   Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField @bind-Value="newEntry.Activities" 
                                Label="Activities" 
                                Required="true"
                                RequiredError="Activities are required"
                                Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField @bind-Value="newEntry.Triggers" 
                                Label="Triggers" 
                                Required="true"
                                RequiredError="Triggers are required"
                                Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudNumericField @bind-Value="newEntry.SleepHours" 
                                   Label="Sleep Hours" 
                                   Min="0" 
                                   Max="24" 
                                   Required="true"
                                   RequiredError="Sleep hours are required"
                                   Class="mt-0" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showAddDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                  OnClick="SaveEntry"
                  Disabled="@(!success)">
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-IsVisible="showEditDialog" 
           Options="dialogOptions"
           FullWidth="true"
           MaxWidth="MaxWidth.Medium">
    <TitleContent>
        <MudText Typo="Typo.h6">Edit entry</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="editForm" @bind-IsValid="@editSuccess">
            <MudGrid>
                <MudItem xs="12">
                    <MudDatePicker Date="@editingEntry.Date"
                                 DateChanged="@(date => editingEntry.Date = date ?? DateTime.Now)"
                                 Label="Date" 
                                 Required="true"
                                 RequiredError="Date is required"
                                 Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudNumericField @bind-Value="editingEntry.MoodLevel" 
                                   Label="Mood (1-10)" 
                                   Min="1" 
                                   Max="10" 
                                   Required="true"
                                   RequiredError="Mood is required"
                                   Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField @bind-Value="editingEntry.Activities" 
                                Label="Activities" 
                                Required="true"
                                RequiredError="Activities are required"
                                Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField @bind-Value="editingEntry.Triggers" 
                                Label="Triggers" 
                                Required="true"
                                RequiredError="Triggers are required"
                                Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudNumericField @bind-Value="editingEntry.SleepHours" 
                                   Label="Sleep Hours" 
                                   Min="0" 
                                   Max="24" 
                                   Required="true"
                                   RequiredError="Sleep hours are required"
                                   Class="mt-0" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showEditDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                  OnClick="UpdateEntry"
                  Disabled="@(!editSuccess)">
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-IsVisible="showDeleteDialog" 
           Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Confirm deletion</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>Are you sure you want to delete this entry?</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showDeleteDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Error" OnClick="ConfirmDelete">Delete</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<MoodEntry>? entries;
    private MoodEntry? selectedEntry;
    private MoodEntry newEntry = new();
    private MoodEntry editingEntry = new();
    private MoodEntry? deletingEntry;
    private bool isLoading = true;
    private string? errorMessage;
    private bool showAddDialog;
    private bool showEditDialog;
    private bool showDeleteDialog;
    private string searchString = "";
    private MudForm? form;
    private bool success;
    private MudForm? editForm;
    private bool editSuccess;
    private DialogOptions dialogOptions = new() { CloseButton = true, MaxWidth = MaxWidth.Small };

    protected override async Task OnInitializedAsync()
    {
        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (!user.Identity?.IsAuthenticated ?? true)
            {
                errorMessage = "You are not signed in. Please sign in to view your entries.";
                return;
            }
            
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            
            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "Could not identify user. Please sign in again.";
                return;
            }
            
            var response = await Http.GetAsync($"api/MoodEntries?userId={userId}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                entries = System.Text.Json.JsonSerializer.Deserialize<List<MoodEntry>>(content, 
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
            else
            {
                errorMessage = $"Error loading entries: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SaveEntry()
    {
        try
        {
            if (!success)
            {
                Snackbar.Add("Please fill in all required fields", Severity.Warning);
                return;
            }

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            
            if (string.IsNullOrEmpty(userId))
            {
                Snackbar.Add("Could not identify user", Severity.Error);
                return;
            }
            
            newEntry.UserId = userId;
            
            var response = await Http.PostAsJsonAsync("api/MoodEntries", newEntry);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Entry added successfully", Severity.Success);
                showAddDialog = false;
                newEntry = new();
                await LoadEntries();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Error saving entry: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void EditEntry(MoodEntry entry)
    {
        editingEntry = new MoodEntry
        {
            Id = entry.Id,
            UserId = entry.UserId,
            Date = entry.Date,
            MoodLevel = entry.MoodLevel,
            Activities = entry.Activities,
            Triggers = entry.Triggers,
            SleepHours = entry.SleepHours
        };
        showEditDialog = true;
    }

    private async Task UpdateEntry()
    {
        try
        {
            if (!editSuccess)
            {
                Snackbar.Add("Please fill in all required fields", Severity.Warning);
                return;
            }

            var response = await Http.PutAsJsonAsync($"api/MoodEntries/{editingEntry.Id}", editingEntry);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Entry updated successfully", Severity.Success);
                showEditDialog = false;
                await LoadEntries();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Error updating entry: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void DeleteEntry(MoodEntry entry)
    {
        deletingEntry = entry;
        showDeleteDialog = true;
    }

    private async Task ConfirmDelete()
    {
        try
        {
            if (deletingEntry == null) return;
            
            var response = await Http.DeleteAsync($"api/MoodEntries/{deletingEntry.Id}");
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Entry deleted successfully", Severity.Success);
                showDeleteDialog = false;
                await LoadEntries();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Error deleting entry: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private bool FilterFunc(MoodEntry entry)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        return entry.Date.ToString("MM/dd/yyyy").Contains(searchString, StringComparison.OrdinalIgnoreCase)
            || entry.MoodLevel.ToString().Contains(searchString, StringComparison.OrdinalIgnoreCase)
            || (entry.Activities?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)
            || (entry.Triggers?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)
            || (entry.SleepHours?.ToString().Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false);
    }

    private string GetMoodIcon(int moodLevel)
    {
        return moodLevel switch
        {
            <= 3 => Icons.Material.Filled.SentimentVeryDissatisfied,
            <= 5 => Icons.Material.Filled.SentimentDissatisfied,
            <= 7 => Icons.Material.Filled.SentimentSatisfied,
            _ => Icons.Material.Filled.SentimentVerySatisfied
        };
    }

    private Color GetMoodColor(int moodLevel)
    {
        return moodLevel switch
        {
            <= 3 => Color.Error,
            <= 5 => Color.Warning,
            <= 7 => Color.Info,
            _ => Color.Success
        };
    }

    private string GetRowClass(MoodEntry entry)
    {
        return entry.MoodLevel switch
        {
            <= 3 => "mud-error",
            <= 5 => "mud-warning",
            _ => "mud-success"
        };
    }
}
