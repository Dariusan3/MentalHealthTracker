@page "/adauga-intrare"
@using MentalHealthTracker.Models
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using MudBlazor
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@attribute [Authorize]

<PageTitle>Mental Health Tracker - Add Entry</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Class="pa-4" Elevation="3">
        <MudText Typo="Typo.h4" Class="mb-4">Add New Entry</MudText>

        <MudForm @ref="form" @bind-IsValid="@success">
            <MudGrid>
                <MudItem xs="12">
                    <MudDatePicker Date="@entry.Date"
                                 DateChanged="@(date => entry.Date = date ?? DateTime.Now)"
                                 Label="Date" 
                                 Required="true"
                                 RequiredError="Date is required"
                                 Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudNumericField @bind-Value="entry.MoodLevel" 
                                   Label="Mood Level (1-10)" 
                                   Min="1" 
                                   Max="10" 
                                   Required="true"
                                   RequiredError="Mood level is required"
                                   Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField @bind-Value="entry.Activities" 
                                Label="Activities" 
                                Required="true"
                                RequiredError="Activities are required"
                                Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField @bind-Value="entry.Triggers" 
                                Label="Triggers" 
                                Required="true"
                                RequiredError="Triggers are required"
                                Class="mt-0" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudNumericField @bind-Value="entry.SleepHours" 
                                   Label="Sleep Hours" 
                                   Min="0" 
                                   Max="24" 
                                   Required="true"
                                   RequiredError="Sleep hours are required"
                                   Class="mt-0" />
                </MudItem>

                <MudItem xs="12" Class="d-flex justify-space-between mt-4">
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Secondary"
                              OnClick="@(() => NavigationManager.NavigateTo("/jurnal"))"
                              Disabled="@isLoading">
                        Cancel
                    </MudButton>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary"
                              OnClick="SaveEntry"
                              Disabled="@(!success || isLoading)">
                        @if (isLoading)
                        {
                            <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        }
                        Save
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    private MoodEntry entry = new();
    private MudForm? form;
    private bool success;
    private bool isLoading;

    private async Task SaveEntry()
    {
        try
        {
            if (!success)
            {
                Snackbar.Add("Please fill in all required fields", Severity.Warning);
                return;
            }

            // Additional validation
            if (entry.Date == default)
            {
                Snackbar.Add("Date is required", Severity.Warning);
                return;
            }

            if (entry.MoodLevel < 1 || entry.MoodLevel > 10)
            {
                Snackbar.Add("Mood level must be between 1 and 10", Severity.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(entry.Activities))
            {
                Snackbar.Add("Activities are required", Severity.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(entry.Triggers))
            {
                Snackbar.Add("Triggers are required", Severity.Warning);
                return;
            }

            if (!entry.SleepHours.HasValue || entry.SleepHours < 0 || entry.SleepHours > 24)
            {
                Snackbar.Add("Sleep hours must be between 0 and 24", Severity.Warning);
                return;
            }

            isLoading = true;

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            
            if (string.IsNullOrEmpty(userId))
            {
                Snackbar.Add("Could not identify user", Severity.Error);
                return;
            }
            
            entry.UserId = userId;
            
            var response = await Http.PostAsJsonAsync("api/MoodEntries", entry);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Entry added successfully", Severity.Success);
                NavigationManager.NavigateTo("/jurnal");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Error saving entry: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
}