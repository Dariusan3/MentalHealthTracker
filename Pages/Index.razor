@page "/home"
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MentalHealthTracker.Models
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@attribute [AllowAnonymous]

<PageTitle>Mental Health Tracker - Home</PageTitle>

<AuthorizeView>
    <Authorized>
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            <MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true" Class="mt-4 mb-2">Welcome, @context.User.Identity?.Name!</MudText>
            <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mb-8">Thank you for using Mental Health Tracker</MudText>

            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudCard Elevation="3" Class="rounded-lg">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h5">Daily Journal</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIcon Icon="@Icons.Material.Filled.Book" Color="Color.Primary" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText>Record your mood and daily thoughts to track your mental health progress.</MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="jurnal" EndIcon="@Icons.Material.Filled.ArrowForward">Add an entry</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudCard Elevation="3" Class="rounded-lg">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h5">Statistics</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIcon Icon="@Icons.Material.Filled.BarChart" Color="Color.Secondary" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText>View your mood trends and identify patterns over time.</MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Filled" Color="Color.Secondary" Href="statistici" EndIcon="@Icons.Material.Filled.ArrowForward">View statistics</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" Class="mt-4">
                    <MudCard Elevation="3" Class="rounded-lg">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h5">Resources</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIcon Icon="@Icons.Material.Filled.LibraryBooks" Color="Color.Info" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText>Discover articles, exercises, and tips to improve your mental health.</MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Filled" Color="Color.Info" Href="resurse" EndIcon="@Icons.Material.Filled.ArrowForward">Explore resources</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" Class="mt-4">
                    <MudCard Elevation="3" Class="rounded-lg">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h5">Profile</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Tertiary" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText>Manage your profile and personal preferences.</MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Filled" Color="Color.Tertiary" Href="profil" EndIcon="@Icons.Material.Filled.ArrowForward">Access profile</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </Authorized>
    <NotAuthorized>
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            <MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true" Class="mt-4 mb-8">Welcome to Mental Health Tracker</MudText>
            
            <MudPaper Elevation="3" Class="pa-6 mx-auto my-4" Style="max-width: 800px;">
                <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4">Monitor and improve your mental health</MudText>
                <MudText Align="Align.Center" Class="mb-4">
                    Mental Health Tracker is an application that helps you monitor your mood, identify factors that influence your mental health, and develop healthy habits.
                </MudText>
                
                <MudGrid Justify="Justify.Center" Class="mt-8">
                    <MudItem xs="12" sm="6" md="5">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="Size.Large" Href="account/login">
                            Sign In
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="5">
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" Size="Size.Large" Href="account/register">
                            Sign Up
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            
            <MudGrid Class="mt-8">
                <MudItem xs="12" sm="4">
                    <MudPaper Elevation="2" Class="pa-4 d-flex flex-column align-center">
                        <MudIcon Icon="@Icons.Material.Filled.Book" Color="Color.Primary" Size="Size.Large" Class="mb-3" />
                        <MudText Typo="Typo.h6" Align="Align.Center">Daily Journal</MudText>
                        <MudText Typo="Typo.body2" Align="Align.Center">Record your mood and daily thoughts.</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudPaper Elevation="2" Class="pa-4 d-flex flex-column align-center">
                        <MudIcon Icon="@Icons.Material.Filled.BarChart" Color="Color.Secondary" Size="Size.Large" Class="mb-3" />
                        <MudText Typo="Typo.h6" Align="Align.Center">Statistics</MudText>
                        <MudText Typo="Typo.body2" Align="Align.Center">View trends and your progress over time.</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudPaper Elevation="2" Class="pa-4 d-flex flex-column align-center">
                        <MudIcon Icon="@Icons.Material.Filled.LibraryBooks" Color="Color.Info" Size="Size.Large" Class="mb-3" />
                        <MudText Typo="Typo.h6" Align="Align.Center">Resources</MudText>
                        <MudText Typo="Typo.body2" Align="Align.Center">Access articles and tips for mental health.</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </NotAuthorized>
</AuthorizeView>

@code {
    private ApplicationUser? currentUser;
    private string? currentUserId;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated == true)
            {
                var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (userId != null)
                {
                    currentUserId = userId;
                    await LoadUserData();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during initialization: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadUserData()
    {
        if (currentUserId != null)
        {
            try
            {
                currentUser = await UserManager.FindByIdAsync(currentUserId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading user data: {ex.Message}");
            }
        }
    }
}
